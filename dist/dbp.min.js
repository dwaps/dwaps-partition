function dwapsBuilderPart(){return function(t,e){return new DWAPS_BUILDER_PART(t,e)}}var options={use:{angular:!0},canvas:{width:window.innerWidth,height:window.innerHeight},font:{family:"Arial",size:10,weight:300},bgColor:"#eed",default:{measureWidth:500,sidePadding:10,offsetY:40,time:"4/4",responsive:!0},help:{clefs:function(t){console.log("\nValables Clefs :"),console.log(t.clefProperties.values)},notes:function(t){console.log("\nValables Notes :"),console.log(t.keyProperties.note_values)},accidentals:function(t){console.log("\nValables Accidentals :"),console.log(t.accidentalCodes.accidentals)},keys:function(t){console.log("\nValables Keys :"),console.log(t.keySignature.keySpecs)},duration:function(t){console.log("\nValables Duration :"),console.log(t.durationToTicks.durations)},articulations:function(t){console.log("\nValables Articulations :"),console.log(t.articulationCodes.articulations)},ornaments:function(t){console.log("\nValables Ornaments :"),console.log(t.ornamentCodes.ornaments)}}};options.use.angular&&angular.module("DWAPS_BUILDER_PART",[]).factory("dwapsBuilderPart",dwapsBuilderPart);var DWAPS_BUILDER_PART=function(t,e){var s=new X2JS,i=s.xml_str2json(e);this.initPart(i["score-partwise"]),this.start(t,options)};DWAPS_BUILDER_PART.prototype={initObject:function(t){return this.VF=Vex.Flow,this.options=t,this.responsive=this.options.default.responsive,this.NB_MAX_MEASURES=2,this.systemOk=!0,this.widthViewer=this.responsive?window.innerWidth:this.partition.infos.page.width,this.heightViewer=this.responsive?window.innerHeight:this.partition.infos.page.height,this.offsetX=this.options.default.sidePadding,this.offsetY=this.options.default.offsetY,this.mode="major",this.en={DOb:"Cb",SOLb:"Bb",REb:"Db",LAb:"Ab",MIb:"Eb",SIb:"Bb",FA:"F",DO:"C",SOL:"G",RE:"D",LA:"A",MI:"E#",SI:"B#",FAd:"F#",DOd:"D#"},this.measures=[],this.SIZES_SYSTEM_AUTO=!0,this.largTotaleMes=0,this.indexFirstMeasureSystem=0,this.mesWidth=[],this.leftMargin=this.options.default.sidePadding,this.CLE_SOL="treble",this.CLE_FA="bass",this.clef=this.CLE_SOL,this.chiffrage=this.options.default.time,this.armature=null,this.note={DO:"c",RE:"d",MI:"e",FA:"f",SOL:"g",LA:"a",SI:"b",DO_POINTEE:"c.",RE_POINTEE:"d.",MI_POINTEE:"e.",FA_POINTEE:"f.",SOL_POINTEE:"g.",LA_POINTEE:"a.",SI_POINTEE:"b."},this.figure={RONDE:"w",BLANCHE:"h",NOIRE:"q",CROCHE:"8",DOUBLE_CROCHE:"16",TRIPLE_CROCHE:"32",QUADRUPLE_CROCHE:"64"},this.voix={BASSE:"basse",TENOR:"tenor",ALTO:"alto",SOPRANO:"soprano",ACTIVE:""},this.voices=[],this.noteTest=["c/4"],this},initCanvas:function(t){this.tag=t;var e=this.renderer=new this.VF.Renderer(t,this.VF.Renderer.Backends.SVG);e.resize(this.widthViewer,this.heightViewer);var s=this.ctx=e.getContext();s.setFont(options.font.family,options.font.size,options.font.weight).setBackgroundFillStyle(options.bgColor)},start:function(t,e){e.default.responsive?this.reload(t,e):(this.initObject(e),this.initCanvas(t),this.buildPart())},setOptions:function(t){this.options=t},getOptions:function(){return this.options},initPart:function(t){function e(e){var s=[];return t.part[e-1].measure.forEach(function(t){s.push(t)}),s}var s={infos:{page:{width:t.defaults["page-layout"]["page-width"],height:t.defaults["page-layout"]["page-height"]},titre:t.work["work-title"],ref:t.identification.creator.__text,systeme:[]},systeme:{portee1:e(1),portee2:!!t.part[1]&&e(2)}};t["part-list"]["score-part"].forEach(function(t){s.infos.systeme.push(t["part-name"])}),this.partition=s},reload:function(t,e){if(this.responsive||this.options&&this.options.default.responsive||e&&e.default.responsive){console.log("reloading...");var s=window.innerWidth;t&&e?(this.initObject(e),this.initCanvas(t)):(this.initObject(this.options),this.tag.innerHTML="",this.initCanvas(this.tag)),s<=1024?(s<=450?this.NB_MAX_MEASURES=1:s<=700?this.NB_MAX_MEASURES=2:s<=768?this.NB_MAX_MEASURES=3:this.NB_MAX_MEASURES=4,this.systemOk=!1):this.systemOk=!0,this.buildPart()}else t&&e&&this.start(t,e)},buildPart:function(){this.dynamicSizingMeasure()},creerMesure:function(t,e){function s(t,e,s){var n=[],r={soprano:[],alto:[],tenor:[],basse:[]};s.note.forEach(function(t,e){if(n.push({voix:t.voice?t.voice:"",pos:t.pitch.octave?t.pitch.octave:"",figure:t.type?t.type:"",ton:t.pitch.step?t.pitch.step:"",hampe:t.stem?t.stem:"",paroles:[]}),t.lyric)for(j=0;j<t.lyric.length;j++)""!=t.lyric[j].text&&n[e].paroles.push(t.lyric[j].text)}),n.forEach(function(t){switch(i(t),t.voix){case"1":r.tenor.push(t)}});for(var a in r)if(r.tenor.length>0){var o=[];switch(r.tenor.forEach(function(t){o.push([[t.ton,t.figure,parseInt(t.pos)]])}),a){case"tenor":t.creerMelodieMesure(e,t.chiffrage,t.voix.TENOR,o)}}}function i(t){switch(t.figure){case"half":t.figure=r.figure.BLANCHE;break;case"quarter":t.figure=r.figure.NOIRE}switch(t.ton){case"C":t.ton=r.note.DO;break;case"D":t.ton=r.note.RE;break;case"E":t.ton=r.note.MI;break;case"F":t.ton=r.note.FA;break;case"G":t.ton=r.note.SOL;break;case"A":t.ton=r.note.LA;break;case"B":t.ton=r.note.SI}}function n(t,e){var s=!!t.match("-");switch(t=t.replace("-","")){case"1":t=s?e.en.FA:e.en.SOL;break;case"2":t=s?e.en.SIb:e.en.RE;break;case"3":t=s?e.en.MIb:e.en.LA;break;case"4":t=s?e.en.LAb:e.en.MI;break;case"5":t=s?e.en.REb:e.en.SI;break;case"6":t=s?e.en.SOLb:e.en.FAd;break;case"7":t=s?e.en.DOb:e.en.DOd;break;default:t="major"==e.mode?e.en.DO:e.en.LAm}return t}var r=this,a=this.options.default.measureWidth,o=[],h=null,u=null,l=null,f=null,c=[];if(!this.responsive&&t&&e>=0){var m={width:parseInt(t._width)};return t.attributes&&(t.attributes.time&&(this.chiffrage=t.attributes.time.beats+"/"+t.attributes.time["beat-type"]),t.attributes.clef&&(this.clef="G"==t.attributes.clef.sign?this.CLE_SOL:this.CLE_FA),t.attributes.key&&(t.attributes.key.fifths&&(this.armature=t.attributes.key.fifths),t.attributes.key.mode&&(this.mode=t.attributes.key.mode))),t.print&&("yes"!=t.print["_new-system"]&&"yes"!=t.print["_new-page"]||(this.indexFirstMeasureSystem=parseInt(t._number)-1,this.leftMargin=this.options.default.sidePadding,"yes"==t.print["_new-system"]&&(this.offsetY+=120),m.clef=this.clef,m.chiffrage=this.chiffrage,m.armature=this.armature,0==e&&t.print["system-layout"]&&t.print["system-layout"]["system-margins"]&&t.print["system-layout"]["system-margins"]["left-margin"]&&(this.leftMargin=parseInt(t.print["system-layout"]["system-margins"]["left-margin"]),this.leftMargin=this.leftMargin-15))),this.offsetX=this.leftMargin,e>0&&"1"!=t._number&&(!t.print||t.print&&"yes"!=t.print["_new-system"]&&"yes"!=t.print["_new-page"]?this.calculOffsetX(e):this.calculOffsetX(e)),m.offsetX=this.offsetX,m.offsetY=this.offsetY,void this.creerMesure(m)}parseInt(t.offsetX)&&(offsetX=t.offsetX),parseInt(t.offsetY)&&(offsetY=t.offsetY),parseInt(t.width)&&(a=t.width),t.clef&&(h=this.clef),t.chiffrage&&(u=this.chiffrage),this.measures.length>0?this.measures.forEach(function(t,e){if(mesure=new r.VF.Stave(t.offsetX,t.offsetY,t.width),t.firstOnNewSystem){var i=n(r.armature,r);i?mesure.addKeySignature(i):mesure.addKeySignature(r.armature),t.clef?mesure.addClef(t.clef):mesure.addClef(r.clef),t.chiffrage?mesure.addTimeSignature(t.chiffrage):mesure.addTimeSignature(r.chiffrage)}mesure.setContext(r.ctx).draw(),s(r,mesure,r.partition.systeme.portee1[e])}):(mesure=new this.VF.Stave(offsetX,offsetY,a),h&&mesure.addClef(h),u&&mesure.addTimeSignature(u),this.armature=n(this.armature,this),this.armature&&mesure.addKeySignature(this.armature),mesure.setContext(this.ctx).draw()),r=null,a=null,o=null,h=null,u=null,l=null,f=null,c=null},calculOffsetX:function(t){for(var e=0,s=0;s<t;s++)e=this.partition.systeme.portee1[s]._width,this.measures[s].firstOnNewSystem&&(this.offsetX=this.leftMargin),this.offsetX+=parseInt(e);e=null},creerMelodieMesure:function(t,e,s,i){var n=[];this.voix.ACTIVE=s?s:this.voix.ACTIVE;for(var r=0;r<i.length;r++)if(Array.isArray(i[r]))switch(this.voix.ACTIVE){case this.voix.BASSE:n.push(this.creerNote({measureType:this.CLE_SOL,notes:i[r],figure:i[r][0][1]}));break;case this.voix.TENOR:n.push(this.creerNote({measureType:this.CLE_SOL,notes:i[r],figure:i[r][0][1]}));break;case this.voix.ALTO:break;case this.voix.SOPRANO:}var a=e.split("/"),o=parseInt(a[0]),h=parseInt(a[1]);this.voices.push(new this.VF.Voice({num_beats:o,beat_value:h}).addTickables(n)),this.VF.Formatter.FormatAndDraw(this.ctx,t,n)},creerNote:function(t){var e=this.CLE_SOL,s=["g/4"],i="q",n=[],r=!1,a=0,o=this;t&&(t.measureType&&(e=t.measureType),t.figure&&(i=t.figure)),t.notes&&(s=[],t.notes.forEach(function(t){switch(t[0]){case o.note.DO_POINTEE:t=o.splitPoint(t),n.push(a++),r=!0;break;case o.note.RE_POINTEE:t=o.splitPoint(t),n.push(a++),r=!0;break;case o.note.MI_POINTEE:t=o.splitPoint(t),n.push(a++),r=!0;break;case o.note.FA_POINTEE:t=o.splitPoint(t),n.push(a++),r=!0;break;case o.note.SOL_POINTEE:t=o.splitPoint(t),n.push(a++),r=!0;break;case o.note.LA_POINTEE:t=o.splitPoint(t),n.push(a++),r=!0;break;case o.note.SI_POINTEE:t=o.splitPoint(t),n.push(a++),r=!0;break;default:a++}s.push(o.genererNote(t))}));var h=new this.VF.StaveNote({clef:e,keys:s,duration:i});return n.length>0&&r&&n.forEach(function(t){h.addDot(parseInt(t))}),h},genererNote:function(t){return t[0]+"/"+t[2]},splitPoint:function(t,e){var s=t[0].split(".");return t[0]=s[0],t},calculPercent:function(t,e,s){return t?e*(100/s):e/100*s},dynamicSizingMeasure:function(){var t=this,e=this.partition.systeme.portee1.length,s=0,i=[],n=0;this.offsetX=this.leftMargin=this.options.default.sidePadding;for(var r=0;r<e;r++){var a=this.partition.systeme.portee1[r];this.measures.push({}),this.measures[r].num=r+1,t.systemOk&&(!a.print||"yes"!=a.print["_new-system"]&&"yes"!=a.print["_new-page"]||(this.measures[r].firstOnNewSystem=!0,0!=r&&(this.offsetY+=120,this.measures[r-1].lastOnOldSystem=!0)),this.measures[r].offsetY=this.offsetY),this.loadAttributs(a,this.measures[r]),a.print&&a.print["system-layout"]&&a.print["system-layout"]["system-margins"]&&a.print["system-layout"]["system-margins"]["left-margin"]&&(this.leftMargin=parseInt(a.print["system-layout"]["system-margins"]["left-margin"]),this.measures[r].hasLeftMargin=!0,this.measures[r].offsetX=this.leftMargin),this.measures[r].hasLeftMargin||this.measures[r].firstOnNewSystem||r>0&&"1"!=a._number&&this.calculOffsetX(r),this.measures[r].hasLeftMargin||(this.measures[r].offsetX=this.offsetX),a=null}if(t.systemOk)this.measures.forEach(function(e,i){if(t.responsive)e.firstOnNewSystem&&(n=0,s++,console.log("Système n°"+s+" (partition responsive)"),e.clef=t.clef,e.chiffrage=t.chiffrage,e.armature=t.armature,e.mode=t.mode),n++;else{var r=t.partition.systeme.portee1[i];e.firstOnNewSystem&&(s++,console.log("Système n°"+s+" (partition statique)"),e.clef=t.clef,e.chiffrage=t.chiffrage,e.armature=t.armature,e.mode=t.mode),e.width=parseInt(r._width)}});else for(var o=0,h=0,r=0;r<e;r++)(0==r||o==this.NB_MAX_MEASURES&&this.responsive)&&(this.measures[r].firstOnNewSystem=!0,this.loadAttributs(!1,this.measures[r]),0!=r&&(this.measures[r-1].lastOnOldSystem=!0,this.offsetY+=120),o=0),this.measures[r].offsetY=this.offsetY,this.measures[r].width=window.innerWidth/this.NB_MAX_MEASURES,this.measures[r].firstOnNewSystem?this.measures[r].offsetX=t.options.default.sidePadding:this.measures[r].offsetX=h+t.options.default.sidePadding,h+=this.measures[r].width,o++;this.responsive&&t.calculLargeur(),this.creerMesure(!0),this.systemOk=!0,t=null,e=null,i=null,n=null},loadAttributs:function(t,e){t.attributes&&(t.attributes.time&&(this.chiffrage=t.attributes.time.beats+"/"+t.attributes.time["beat-type"],e.chiffrage=this.chiffrage),t.attributes.clef&&(this.clef="G"==t.attributes.clef.sign?this.CLE_SOL:this.CLE_FA,e.clef=this.clef),t.attributes.key&&(t.attributes.key.fifths&&(this.armature=t.attributes.key.fifths,e.armature=this.armature),t.attributes.key.mode&&(this.mode=t.attributes.key.mode)))},calculLargeur:function(){var t=this,e=window.innerWidth-2*this.options.default.sidePadding,s=parseInt(this.partition.infos.page.width),i=0,n=0,r=null,a=0,o=[],h=[],u=[],l=0,f=0,c=0,m=0;return this.measures.forEach(function(r,h){if(r.firstOnNewSystem){r.hasLeftMargin&&(f=r.offsetX,m=t.calculPercent(!0,f,s),l=t.calculPercent(!1,m,e));for(var u=0,d=r.num-1;d<t.measures.length&&(o.push(parseFloat(t.partition.systeme.portee1[d]._width)),a+=o[u],u++,!t.measures[d].lastOnOldSystem);d++);c=0!=l?l/o.length:0,i=s-a-f,m=t.calculPercent(!0,i,s),n=t.calculPercent(!1,m,e),c+=n/o.length,u=0,concatWidth=0;for(var d=r.num-1;d<t.measures.length&&(m=t.calculPercent(!0,o[u],t.partition.infos.page.width),t.measures[d].width=t.calculPercent(!1,m,e)+c,0==u?t.measures[d].offsetX=t.options.default.sidePadding:t.measures[d].offsetX=concatWidth+t.options.default.sidePadding,concatWidth+=t.measures[d].width,u++,!t.measures[d].lastOnOldSystem);d++);a=0,f=0,l=0,o=[],a=0}}),e=null,s=null,i=null,n=null,r=null,a=null,o=null,h=null,u=null,l=null,f=null,c=null,m=null,cpt=null,o}};