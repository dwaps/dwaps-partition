function dwapsBuilderPart(){return function(t,e){return new DWAPS_BUILDER_PART(t,e)}}var options={use:{angular:!0},canvas:{width:window.innerWidth,height:window.innerHeight},font:{family:"Arial",size:10,weight:300},bgColor:"#eed",default:{measureWidth:500,sidePadding:10,offsetY:40,time:"4/4",responsive:!0},help:{clefs:function(t){console.log("\nValables Clefs :"),console.log(t.clefProperties.values)},notes:function(t){console.log("\nValables Notes :"),console.log(t.keyProperties.note_values)},accidentals:function(t){console.log("\nValables Accidentals :"),console.log(t.accidentalCodes.accidentals)},keys:function(t){console.log("\nValables Keys :"),console.log(t.keySignature.keySpecs)},duration:function(t){console.log("\nValables Duration :"),console.log(t.durationToTicks.durations)},articulations:function(t){console.log("\nValables Articulations :"),console.log(t.articulationCodes.articulations)},ornaments:function(t){console.log("\nValables Ornaments :"),console.log(t.ornamentCodes.ornaments)}}};options.use.angular&&angular.module("DWAPS_BUILDER_PART",[]).factory("dwapsBuilderPart",dwapsBuilderPart);var DWAPS_BUILDER_PART=function(t,e){var s=this,i=new X2JS,a=i.xml_str2json(e);this.initPart(a["score-partwise"]),this.start(t,options,!1),window.addEventListener("resize",function(){s.start(t,options,!0)},!1)};DWAPS_BUILDER_PART.prototype={initObject:function(t,e){if(this.options=t,this.responsive=this.options.default.responsive,this.NB_MAX_MEASURES=-1,this.systemOk=!0,this.offsetX=this.options.default.sidePadding,this.offsetY=this.options.default.offsetY,this.calculNbMeasures(),this.calculSizeViewer(),this.leftMargin=this.options.default.sidePadding,this.chiffrage=this.options.default.time,!e)return this.VF=Vex.Flow,this.mode="major",this.en={DOb:"Cb",SOLb:"Bb",REb:"Db",LAb:"Ab",MIb:"Eb",SIb:"Bb",FA:"F",DO:"C",SOL:"G",RE:"D",LA:"A",MI:"E#",SI:"B#",FAd:"F#",DOd:"D#"},this.NB_PORTEES_SYSTEME=1,this.partition&&this.partition.systeme.portee2&&(this.NB_PORTEES_SYSTEME=2),this.mesStaticPart=[],this.mesDynamicPart=[],this.mesVF=[],this.mesMelodie=[],this.SIZES_SYSTEM_AUTO=!0,this.largTotaleMes=0,this.indexFirstMeasureSystem=0,this.mesWidth=[],this.CLE_SOL="treble",this.CLE_FA="bass",this.clef=this.CLE_SOL,this.armature=null,this.note={DO:"c",RE:"d",MI:"e",FA:"f",SOL:"g",LA:"a",SI:"b",DO_POINTEE:"c.",RE_POINTEE:"d.",MI_POINTEE:"e.",FA_POINTEE:"f.",SOL_POINTEE:"g.",LA_POINTEE:"a.",SI_POINTEE:"b."},this.figure={RONDE:"w",BLANCHE:"h",NOIRE:"q",CROCHE:"8",DOUBLE_CROCHE:"16",TRIPLE_CROCHE:"32",QUADRUPLE_CROCHE:"64"},this.voix={BASSE:"basse",TENOR:"tenor",ALTO:"alto",SOPRANO:"soprano",NULL:"aucune voix précisée",ACTIVE:""},this.voices=[],this},calculNbMeasures:function(){if(this.responsive){var t=window.innerWidth;t<=1024?(t<=450?this.NB_MAX_MEASURES=1:t<=700?this.NB_MAX_MEASURES=2:t<=768?this.NB_MAX_MEASURES=3:this.NB_MAX_MEASURES=4,this.systemOk=!1):this.systemOk=!0}},calculSizeViewer:function(){var t=this.partition.infos.page.width,e=this.partition.infos.page.height;if(this.responsive){switch(e=2==this.NB_PORTEES_SYSTEME?260:135,this.NB_MAX_MEASURES){case 1:e*=this.partition.systeme.portee1.length;break;case 2:e*=this.partition.systeme.portee1.length/2;break;case 3:e*=this.partition.systeme.portee1.length/3;break;case 4:e*=this.partition.systeme.portee1.length/4;break;default:e*=this.partition.systeme.portee1.length/5}e+=this.offsetY}this.widthViewer=t,this.heightViewer=e},initCanvas:function(t){this.tag=t,this.renderer=new this.VF.Renderer(t,this.VF.Renderer.Backends.SVG),this.renderer.resize(this.widthViewer,this.heightViewer),this.ctx=this.renderer.getContext(),this.ctx.setFont(options.font.family,options.font.size,options.font.weight).setBackgroundFillStyle(options.bgColor)},start:function(t,e,s){if(!s||this.responsive){var i=(e?e:this.options,t?t:this.tag);i.innerHTML="",this.initObject(e,s),this.initCanvas(t),this.buildPart(s)}},setOptions:function(t){this.options=t,this.start(this.tag,t,!0)},getOptions:function(){return this.options},initPart:function(t){function e(e){var s=[];return t.part[e-1].measure.forEach(function(t){s.push(t)}),s}var s={infos:{page:{width:t.defaults["page-layout"]["page-width"],height:t.defaults["page-layout"]["page-height"]},titre:t.work["work-title"],ref:t.identification.creator.__text,systeme:[]},systeme:{portee1:e(1),portee2:!!t.part[1]&&e(2)}};t["part-list"]["score-part"].forEach(function(t){s.infos.systeme.push(t["part-name"])}),this.partition=s},buildPart:function(t){this.sizingMeasures(t)},creerMesure:function(t,e,s){function i(t,e){var s=!!t.match("-");switch(t=t.replace("-","")){case"1":t=s?e.en.FA:e.en.SOL;break;case"2":t=s?e.en.SIb:e.en.RE;break;case"3":t=s?e.en.MIb:e.en.LA;break;case"4":t=s?e.en.LAb:e.en.MI;break;case"5":t=s?e.en.REb:e.en.SI;break;case"6":t=s?e.en.SOLb:e.en.FAd;break;case"7":t=s?e.en.DOb:e.en.DOd;break;default:t="major"==e.mode?e.en.DO:e.en.LAm}return t}function a(t,e,s,i){mesure=new l.VF.Stave(t.offsetX,t.offsetY+100,t.width),t.firstOnNewSystem&&(mesure.addKeySignature(e),mesure.addClef(l.CLE_FA),mesure.addTimeSignature(i)),mesure.setContext(l.ctx).draw(),l.mesVF.push(mesure)}function r(t,e,s){var i=[],a={soprano:[],alto:[],tenor:[],basse:[],sansVoix:[]};s.note.forEach(function(t,e){if(i.push({voix:t.voice?t.voice:"",pos:t.pitch.octave?parseInt(t.pitch.octave):"",figure:t.type?t.type:"",ton:t.pitch.step?t.pitch.step:"",hampe:t.stem?t.stem:"",paroles:[],offsetX:t["_default-x"]}),t.lyric)for(w=0;w<t.lyric.length;w++)""!=t.lyric[w].text&&i[e].paroles.push(t.lyric[w].text)});var r=0;i.forEach(function(t,e){n(t),r=o(s,t,e,a,r)});for(var u in a){var c=[],m=[],p=[],d=[];switch(u){case"soprano":h(a.soprano,a.sansVoix,c),f(s._number,e,t,l.voix.SOPRANO,c);break;case"alto":h(a.alto,a.sansVoix,m),f(s._number,e,t,l.voix.ALTO,m);break;case"tenor":h(a.tenor,a.sansVoix,p),f(s._number,e,t,l.voix.TENOR,p);break;case"basse":h(a.basse,a.sansVoix,d),f(s._number,e,t,l.voix.BASSE,d);break;case"sansVoix":}}}function n(t){if(t){switch(t.figure){case"half":t.figure=l.figure.BLANCHE;break;case"quarter":t.figure=l.figure.NOIRE}switch(t.ton){case"C":t.ton=l.note.DO;break;case"D":t.ton=l.note.RE;break;case"E":t.ton=l.note.MI;break;case"F":t.ton=l.note.FA;break;case"G":t.ton=l.note.SOL;break;case"A":t.ton=l.note.LA;break;case"B":t.ton=l.note.SI}}}function o(t,e,s,i,a){if(s>0&&t.note[s-1]["_default-x"]==e.offsetX)if(a>0)switch(e.voix){case"2":i.alto[a-1]=e;break;case"1":i.tenor[a-1]=e;break;default:i.sansVoix[a-1]=e}else switch(e.voix){case"2":i.alto[0]=e;break;case"1":i.tenor[0]=e;break;default:i.sansVoix[0]=e}else{switch(e.voix){case"2":i.alto.push(e);break;case"1":i.tenor.push(e);break;default:i.sansVoix.push(e)}for(var r in i)a<i[r].length&&(a=i[r].length);for(var r in i)i[r].length<a&&i[r].push(null)}return a}function h(t,e,s){t.forEach(function(t,i){if(t)if(e[i]&&e[i].offsetX==t.offsetX){var a={},r={};if(e[i].pos>t.pos)a={ton:t.ton,figure:t.figure,pos:t.pos,hampe:t.hampe},r={ton:e[i].ton,figure:e[i].figure,pos:e[i].pos,hampe:e[i].hampe};else if(e[i].pos==t.pos){for(var n=["c","d","e","f","g","a","b"],o=-1,h=-1,f=0;f<7;f++)t.ton==n[f]&&(o=f),e[i].ton==n[f]&&(h=f);o>-1&&h>-1&&(o>h?(a={ton:e[i].ton,figure:e[i].figure,pos:e[i].pos,hampe:e[i].hampe},r={ton:t.ton,figure:t.figure,pos:t.pos,hampe:t.hampe}):(a={ton:t.ton,figure:t.figure,pos:t.pos,hampe:t.hampe},r={ton:e[i].ton,figure:e[i].figure,pos:e[i].pos,hampe:e[i].hampe}))}else a={ton:e[i].ton,figure:e[i].figure,pos:e[i].pos,hampe:e[i].hampe},r={ton:t.ton,figure:t.figure,pos:t.pos,hampe:t.hampe};s.push([[a.ton,a.figure,a.pos,a.hampe],[r.ton,r.figure,r.pos,r.hampe]])}else s.push([[t.ton,t.figure,t.pos,t.hampe]])})}function f(t,e,s,i,a){a.length>0&&l.creerMelodieMesure(t,e,s,l.chiffrage,i,a)}var l=this,u=this.options.default.measureWidth,c=[],m=null,p=null,d=null,g=null,y=[];if(!this.responsive&&t&&s>=0){var S={width:parseInt(t._width)};return t.attributes&&(t.attributes.time&&(this.chiffrage=t.attributes.time.beats+"/"+t.attributes.time["beat-type"]),t.attributes.clef&&(this.clef="G"==t.attributes.clef.sign?this.CLE_SOL:this.CLE_FA),t.attributes.key&&(t.attributes.key.fifths&&(this.armature=t.attributes.key.fifths),t.attributes.key.mode&&(this.mode=t.attributes.key.mode))),t.print&&("yes"!=t.print["_new-system"]&&"yes"!=t.print["_new-page"]||(this.indexFirstMeasureSystem=parseInt(t._number)-1,this.leftMargin=this.options.default.sidePadding,"yes"==t.print["_new-system"]&&(this.offsetY+=120),S.clef=this.clef,S.chiffrage=this.chiffrage,S.armature=this.armature,0==s&&t.print["system-layout"]&&t.print["system-layout"]["system-margins"]&&t.print["system-layout"]["system-margins"]["left-margin"]&&(this.leftMargin=parseInt(t.print["system-layout"]["system-margins"]["left-margin"]),this.leftMargin=this.leftMargin-15))),this.offsetX=this.leftMargin,s>0&&"1"!=t._number&&(!t.print||t.print&&"yes"!=t.print["_new-system"]&&"yes"!=t.print["_new-page"]?this.calculOffsetX(s):this.calculOffsetX(s)),S.offsetX=this.offsetX,S.offsetY=this.offsetY,void this.creerMesure(S,e)}parseInt(t.offsetX)&&(offsetX=t.offsetX),parseInt(t.offsetY)&&(offsetY=t.offsetY),parseInt(t.width)&&(u=t.width),t.clef&&(m=this.clef),t.chiffrage&&(p=this.chiffrage);var b=this.responsive?this.mesDynamicPart:this.mesStaticPart;if(console.log(b),this.mesStaticPart.length>0)if(e){for(var E=[],P=-1,w=0;w<l.mesMelodie.length;w++)w>0&&l.mesMelodie[w][0]==l.mesMelodie[w-1][0]&&l.mesMelodie[w][1]==l.mesMelodie[w-1][1]?E[P][2].concat(l.mesMelodie[w-1][2]):(E.push(l.mesMelodie[w]),P++);this.mesVF.forEach(function(t,e){t.setContext(l.ctx).draw(),l.VF.Formatter.FormatAndDraw(l.ctx,t,E[e][2])})}else this.mesStaticPart.forEach(function(t,e){mesure=new l.VF.Stave(t.offsetX,t.offsetY,t.width),t.firstOnNewSystem&&(d=i(l.armature,l),d||(d=l.armature),mesure.addKeySignature(d),m=t.clef,m||(m=l.clef),mesure.addClef(m),p=t.chiffrage,p||(p=l.chiffrage),mesure.addTimeSignature(p)),mesure.setContext(l.ctx).draw(),r(!0,mesure,l.partition.systeme.portee1[e]),l.mesVF.push(mesure),2==l.NB_PORTEES_SYSTEME&&(a(t,d,m,p),r(!1,mesure,l.partition.systeme.portee2[e]))});else mesure=new this.VF.Stave(offsetX,offsetY,u),m&&mesure.addClef(m),p&&mesure.addTimeSignature(p),this.armature=i(this.armature,this),this.armature&&mesure.addKeySignature(this.armature),mesure.setContext(this.ctx).draw(),this.mesVF.push(mesure);l=null,u=null,c=null,m=null,p=null,d=null,g=null,y=null},calculOffsetX:function(t){for(var e=0,s=0;s<t;s++)e=this.partition.systeme.portee1[s]._width,this.mesStaticPart[s].firstOnNewSystem&&(this.offsetX=this.leftMargin),this.offsetX+=parseInt(e);e=null},creerMelodieMesure:function(t,e,s,i,a,r){var n=[],o=s?this.CLE_SOL:this.CLE_FA;this.voix.ACTIVE=a?a:this.voix.ACTIVE;for(var h=0;h<r.length;h++)Array.isArray(r[h])&&n.push(this.creerNote({measureType:o,notes:r[h],figureAndStem:r[h]}));var f=i.split("/"),l=parseInt(f[0]),u=parseInt(f[1]);this.voices.push(new this.VF.Voice({num_beats:l,beat_value:u}).addTickables(n)),this.VF.Formatter.FormatAndDraw(this.ctx,e,n),this.mesMelodie.push([t,o,n])},creerNote:function(t){var e=this.CLE_SOL,s=["g/4"],i="q",a=[],r=!1,n=0,o=this;if(t&&(t.measureType&&(e=t.measureType),t.figureAndStem))switch(i=t.figureAndStem[0][1],stem=""!=t.figureAndStem[0][3]?t.figureAndStem[0][3]:0,stem){case"down":stem=-1;break;case"up":stem=1;break;default:stem=0}t.notes&&(s=[],t.notes.forEach(function(t){if(t[0][0].indexOf(".")>-1){var t=t[0][0],e=t.split(".");t[0]=e[0],a.push(n++),r=!0}else n++;s.push(o.genererNote(t))}));var h=new this.VF.StaveNote({clef:e,keys:s,duration:i,stem_direction:stem});return a.length>0&&r&&a.forEach(function(t){h.addDot(parseInt(t))}),h},genererNote:function(t){return t[0]+"/"+t[2]},calculPercent:function(t,e,s){return t?e*(100/s):e/100*s},sizingMeasures:function(t){var e=this,s=this.partition.systeme.portee1.length,i=0,a=[],r=0;if(this.offsetX=this.leftMargin=this.options.default.sidePadding,!t){for(var n=0;n<s;n++){var o;o=this.partition.systeme.portee1[n],this.mesStaticPart.push({}),this.mesStaticPart[n].num=n+1,e.systemOk&&(!o.print||"yes"!=o.print["_new-system"]&&"yes"!=o.print["_new-page"]||(this.mesStaticPart[n].firstOnNewSystem=!0,0!=n&&(this.offsetY+=2==this.NB_PORTEES_SYSTEME?250:120,this.mesStaticPart[n-1].lastOnOldSystem=!0)),this.mesStaticPart[n].offsetY=this.offsetY),this.loadAttributs(o,this.mesStaticPart[n]),o.print&&o.print["system-layout"]&&o.print["system-layout"]["system-margins"]&&o.print["system-layout"]["system-margins"]["left-margin"]&&(this.leftMargin=parseInt(o.print["system-layout"]["system-margins"]["left-margin"]),this.mesStaticPart[n].hasLeftMargin=!0,this.mesStaticPart[n].offsetX=this.leftMargin),this.mesStaticPart[n].hasLeftMargin||this.mesStaticPart[n].firstOnNewSystem||n>0&&"1"!=o._number&&this.calculOffsetX(n),this.mesStaticPart[n].hasLeftMargin||(this.mesStaticPart[n].offsetX=this.offsetX),o=null}this.mesDynamicPart=this.mesStaticPart}if(e.systemOk)this.mesDynamicPart.forEach(function(s,a){if(e.responsive||t)s.firstOnNewSystem&&(r=0,i++,s.clef=e.clef,s.chiffrage=e.chiffrage,s.armature=e.armature,s.mode=e.mode),r++;else{var n=e.partition.systeme.portee1[a];e.mesStaticPart[a].firstOnNewSystem&&(i++,e.mesStaticPart[a].clef=e.clef,e.mesStaticPart[a].chiffrage=e.chiffrage,e.mesStaticPart[a].armature=e.armature,e.mesStaticPart[a].mode=e.mode),e.mesStaticPart[a].width=parseInt(n._width)}});else for(var h=0,f=0,n=0;n<s;n++)(0==n||h==this.NB_MAX_MEASURES&&this.responsive)&&(this.mesDynamicPart[n].firstOnNewSystem=!0,this.loadAttributs(!1,this.mesDynamicPart[n]),0!=n&&(this.mesDynamicPart[n-1].lastOnOldSystem=!0,this.offsetY+=this.partition.systeme.portee2?250:120),h=0),this.mesDynamicPart[n].offsetY=this.offsetY,this.mesDynamicPart[n].width=window.innerWidth/this.NB_MAX_MEASURES,this.mesDynamicPart[n].firstOnNewSystem?this.mesDynamicPart[n].offsetX=e.options.default.sidePadding:this.mesDynamicPart[n].offsetX=f+e.options.default.sidePadding,f+=this.mesDynamicPart[n].width,h++;this.responsive&&e.calculLargeur(),this.creerMesure(!0,t),this.systemOk=!0,e=null,s=null,a=null,r=null},loadAttributs:function(t,e){t.attributes&&(t.attributes.time&&(this.chiffrage=t.attributes.time.beats+"/"+t.attributes.time["beat-type"],e.chiffrage=this.chiffrage),t.attributes.clef&&(this.clef="G"==t.attributes.clef.sign?this.CLE_SOL:this.CLE_FA,e.clef=this.clef),t.attributes.key&&(t.attributes.key.fifths&&(this.armature=t.attributes.key.fifths,e.armature=this.armature),t.attributes.key.mode&&(this.mode=t.attributes.key.mode)))},calculLargeur:function(){var t=this,e=window.innerWidth-2*this.options.default.sidePadding,s=parseInt(this.partition.infos.page.width),i=0,a=0,r=null,n=0,o=[],h=[],f=[],l=0,u=0,c=0,m=0;return this.mesDynamicPart.forEach(function(r,h){if(r.firstOnNewSystem){r.hasLeftMargin&&(u=r.offsetX,m=t.calculPercent(!0,u,s),l=t.calculPercent(!1,m,e));for(var f=0,p=r.num-1;p<t.mesDynamicPart.length&&(o.push(parseFloat(t.partition.systeme.portee1[p]._width)),n+=o[f],f++,!t.mesDynamicPart[p].lastOnOldSystem);p++);c=0!=l?l/o.length:0,i=s-n-u,m=t.calculPercent(!0,i,s),a=t.calculPercent(!1,m,e),c+=a/o.length,f=0,concatWidth=0;for(var p=r.num-1;p<t.mesDynamicPart.length&&(m=t.calculPercent(!0,o[f],t.partition.infos.page.width),t.mesDynamicPart[p].width=t.calculPercent(!1,m,e)+c,0==f?t.mesDynamicPart[p].offsetX=t.options.default.sidePadding:t.mesDynamicPart[p].offsetX=concatWidth+t.options.default.sidePadding,concatWidth+=t.mesDynamicPart[p].width,f++,!t.mesDynamicPart[p].lastOnOldSystem);p++);n=0,u=0,l=0,o=[],n=0}}),e=null,s=null,i=null,a=null,r=null,n=null,o=null,h=null,f=null,l=null,u=null,c=null,m=null,cpt=null,o}};