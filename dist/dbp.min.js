function dwapsBuilderPart(){return function(e,t){return new DWAPS_BUILDER_PART(e,t)}}var options={use:{angular:!0},canvas:{width:window.innerWidth,height:window.innerHeight},font:{family:"Arial",size:10,weight:300},bgColor:"#eed",default:{measureWidth:500,sidePadding:10,offsetY:40,time:"4/4",responsive:!0},help:{clefs:function(e){console.log("\nValables Clefs :"),console.log(e.clefProperties.values)},notes:function(e){console.log("\nValables Notes :"),console.log(e.keyProperties.note_values)},accidentals:function(e){console.log("\nValables Accidentals :"),console.log(e.accidentalCodes.accidentals)},keys:function(e){console.log("\nValables Keys :"),console.log(e.keySignature.keySpecs)},duration:function(e){console.log("\nValables Duration :"),console.log(e.durationToTicks.durations)},articulations:function(e){console.log("\nValables Articulations :"),console.log(e.articulationCodes.articulations)},ornaments:function(e){console.log("\nValables Ornaments :"),console.log(e.ornamentCodes.ornaments)}}};options.use.angular&&angular.module("DWAPS_BUILDER_PART",[]).factory("dwapsBuilderPart",dwapsBuilderPart);var DWAPS_BUILDER_PART=function(e,t){var s=this,i=new X2JS,r=i.xml_str2json(t);this.initPart(r["score-partwise"]),this.start(e,options),window.addEventListener("resize",function(){s.start(e,options)},!1)};DWAPS_BUILDER_PART.prototype={initObject:function(e){return this.VF=Vex.Flow,this.options=e,this.responsive=this.options.default.responsive,this.NB_MAX_MEASURES=-1,this.systemOk=!0,this.offsetX=this.options.default.sidePadding,this.offsetY=this.options.default.offsetY,this.mode="major",this.en={DOb:"Cb",SOLb:"Bb",REb:"Db",LAb:"Ab",MIb:"Eb",SIb:"Bb",FA:"F",DO:"C",SOL:"G",RE:"D",LA:"A",MI:"E#",SI:"B#",FAd:"F#",DOd:"D#"},this.NB_PORTEES_SYSTEME=1,this.partition&&this.partition.systeme.portee2&&(this.NB_PORTEES_SYSTEME=2),this.calculNbMeasures(),this.calculSizeViewer(),this.measures=[],this.SIZES_SYSTEM_AUTO=!0,this.largTotaleMes=0,this.indexFirstMeasureSystem=0,this.mesWidth=[],this.leftMargin=this.options.default.sidePadding,this.CLE_SOL="treble",this.CLE_FA="bass",this.clef=this.CLE_SOL,this.chiffrage=this.options.default.time,this.armature=null,this.note={DO:"c",RE:"d",MI:"e",FA:"f",SOL:"g",LA:"a",SI:"b",DO_POINTEE:"c.",RE_POINTEE:"d.",MI_POINTEE:"e.",FA_POINTEE:"f.",SOL_POINTEE:"g.",LA_POINTEE:"a.",SI_POINTEE:"b."},this.figure={RONDE:"w",BLANCHE:"h",NOIRE:"q",CROCHE:"8",DOUBLE_CROCHE:"16",TRIPLE_CROCHE:"32",QUADRUPLE_CROCHE:"64"},this.voix={BASSE:"basse",TENOR:"tenor",ALTO:"alto",SOPRANO:"soprano",NULL:"aucune voix précisée",ACTIVE:""},this.voices=[],this.noteTest=["c/4"],this},calculNbMeasures:function(){if(this.responsive){var e=window.innerWidth;e<=1024?(e<=450?this.NB_MAX_MEASURES=1:e<=700?this.NB_MAX_MEASURES=2:e<=768?this.NB_MAX_MEASURES=3:this.NB_MAX_MEASURES=4,this.systemOk=!1):this.systemOk=!0}},calculSizeViewer:function(){var e=window.innerWidth,t=this.partition.infos.page.height;if(this.responsive){switch(t=2==this.NB_PORTEES_SYSTEME?260:135,this.NB_MAX_MEASURES){case 1:t*=this.partition.systeme.portee1.length;break;case 2:t*=this.partition.systeme.portee1.length/2;break;case 3:t*=this.partition.systeme.portee1.length/3;break;case 4:t*=this.partition.systeme.portee1.length/4;break;default:t*=this.partition.systeme.portee1.length/5}t+=this.offsetY}this.widthViewer=e,this.heightViewer=t},initCanvas:function(e){this.tag=e,this.renderer=new this.VF.Renderer(e,this.VF.Renderer.Backends.SVG),this.renderer.resize(this.widthViewer,this.heightViewer),this.ctx=this.renderer.getContext(),this.ctx.setFont(options.font.family,options.font.size,options.font.weight).setBackgroundFillStyle(options.bgColor)},start:function(e,t){var s=(t?t:this.options,e?e:this.tag);s.innerHTML="",this.initObject(t),this.initCanvas(e),this.buildPart()},setOptions:function(e){this.options=e,this.start(!1,e)},getOptions:function(){return this.options},initPart:function(e){function t(t){var s=[];return e.part[t-1].measure.forEach(function(e){s.push(e)}),s}var s={infos:{page:{width:e.defaults["page-layout"]["page-width"],height:e.defaults["page-layout"]["page-height"]},titre:e.work["work-title"],ref:e.identification.creator.__text,systeme:[]},systeme:{portee1:t(1),portee2:!!e.part[1]&&t(2)}};e["part-list"]["score-part"].forEach(function(e){s.infos.systeme.push(e["part-name"])}),this.partition=s},buildPart:function(){this.dynamicSizingMeasure()},creerMesure:function(e,t){function s(e,t){var s=!!e.match("-");switch(e=e.replace("-","")){case"1":e=s?t.en.FA:t.en.SOL;break;case"2":e=s?t.en.SIb:t.en.RE;break;case"3":e=s?t.en.MIb:t.en.LA;break;case"4":e=s?t.en.LAb:t.en.MI;break;case"5":e=s?t.en.REb:t.en.SI;break;case"6":e=s?t.en.SOLb:t.en.FAd;break;case"7":e=s?t.en.DOb:t.en.DOd;break;default:e="major"==t.mode?t.en.DO:t.en.LAm}return e}function i(e,t,s,i){mesure=new u.VF.Stave(e.offsetX,e.offsetY+100,e.width),e.firstOnNewSystem&&(mesure.addKeySignature(t),mesure.addClef(u.CLE_FA),mesure.addTimeSignature(i)),mesure.setContext(u.ctx).draw()}function r(e,t,s){var i=[],r={soprano:[],alto:[],tenor:[],basse:[],sansVoix:[]};s.note.forEach(function(e,t){if(i.push({voix:e.voice?e.voice:"",pos:e.pitch.octave?parseInt(e.pitch.octave):"",figure:e.type?e.type:"",ton:e.pitch.step?e.pitch.step:"",hampe:e.stem?e.stem:"",paroles:[],offsetX:e["_default-x"]}),e.lyric)for(j=0;j<e.lyric.length;j++)""!=e.lyric[j].text&&i[t].paroles.push(e.lyric[j].text)});var u=0;i.forEach(function(e,t){a(e),u=n(s,e,t,r,u)});for(var h in r){var l=[],c=[],m=[],p=[];switch(h){case"soprano":o(r.soprano,r.sansVoix,l),f(t,e.voix.SOPRANO,l);break;case"alto":o(r.alto,r.sansVoix,c),f(t,e.voix.ALTO,c);break;case"tenor":o(r.tenor,r.sansVoix,m),f(t,e.voix.TENOR,m);break;case"basse":o(r.basse,r.sansVoix,p),f(t,e.voix.BASSE,p);break;case"sansVoix":}}}function a(e){if(e){switch(e.figure){case"half":e.figure=u.figure.BLANCHE;break;case"quarter":e.figure=u.figure.NOIRE}switch(e.ton){case"C":e.ton=u.note.DO;break;case"D":e.ton=u.note.RE;break;case"E":e.ton=u.note.MI;break;case"F":e.ton=u.note.FA;break;case"G":e.ton=u.note.SOL;break;case"A":e.ton=u.note.LA;break;case"B":e.ton=u.note.SI}}}function n(e,t,s,i,r){if(s>0&&e.note[s-1]["_default-x"]==t.offsetX)if(r>0)switch(t.voix){case"2":i.alto[r-1]=t;break;case"1":i.tenor[r-1]=t;break;default:i.sansVoix[r-1]=t}else switch(t.voix){case"2":i.alto[0]=t;break;case"1":i.tenor[0]=t;break;default:i.sansVoix[0]=t}else{switch(t.voix){case"2":i.alto.push(t);break;case"1":i.tenor.push(t);break;default:i.sansVoix.push(t)}for(var a in i)r<i[a].length&&(r=i[a].length);for(var a in i)i[a].length<r&&i[a].push(null)}return r}function o(e,t,s){e.forEach(function(e,i){if(e)if(t[i]&&t[i].offsetX==e.offsetX){var r={},a={};if(t[i].pos>e.pos)r={ton:e.ton,figure:e.figure,pos:e.pos,hampe:e.hampe},a={ton:t[i].ton,figure:t[i].figure,pos:t[i].pos,hampe:t[i].hampe};else if(t[i].pos==e.pos){for(var n=["c","d","e","f","g","a","b"],o=-1,f=-1,u=0;u<7;u++)e.ton==n[u]&&(o=u),t[i].ton==n[u]&&(f=u);o>-1&&f>-1&&(o>f?(r={ton:t[i].ton,figure:t[i].figure,pos:t[i].pos,hampe:t[i].hampe},a={ton:e.ton,figure:e.figure,pos:e.pos,hampe:e.hampe}):(r={ton:e.ton,figure:e.figure,pos:e.pos,hampe:e.hampe},a={ton:t[i].ton,figure:t[i].figure,pos:t[i].pos,hampe:t[i].hampe}))}else r={ton:t[i].ton,figure:t[i].figure,pos:t[i].pos,hampe:t[i].hampe},a={ton:e.ton,figure:e.figure,pos:e.pos,hampe:e.hampe};s.push([[r.ton,r.figure,r.pos,r.hampe],[a.ton,a.figure,a.pos,a.hampe]])}else s.push([[e.ton,e.figure,e.pos,e.hampe]])})}function f(e,t,s){s.length>0&&(t==u.voix.BASSE||u.creerMelodieMesure(e,u.chiffrage,t,s))}var u=this,h=this.options.default.measureWidth,l=[],c=null,m=null,p=null,d=null,g=[];if(!this.responsive&&e&&t>=0){var y={width:parseInt(e._width)};return e.attributes&&(e.attributes.time&&(this.chiffrage=e.attributes.time.beats+"/"+e.attributes.time["beat-type"]),e.attributes.clef&&(this.clef="G"==e.attributes.clef.sign?this.CLE_SOL:this.CLE_FA),e.attributes.key&&(e.attributes.key.fifths&&(this.armature=e.attributes.key.fifths),e.attributes.key.mode&&(this.mode=e.attributes.key.mode))),e.print&&("yes"!=e.print["_new-system"]&&"yes"!=e.print["_new-page"]||(this.indexFirstMeasureSystem=parseInt(e._number)-1,this.leftMargin=this.options.default.sidePadding,"yes"==e.print["_new-system"]&&(this.offsetY+=120),y.clef=this.clef,y.chiffrage=this.chiffrage,y.armature=this.armature,0==t&&e.print["system-layout"]&&e.print["system-layout"]["system-margins"]&&e.print["system-layout"]["system-margins"]["left-margin"]&&(this.leftMargin=parseInt(e.print["system-layout"]["system-margins"]["left-margin"]),this.leftMargin=this.leftMargin-15))),this.offsetX=this.leftMargin,t>0&&"1"!=e._number&&(!e.print||e.print&&"yes"!=e.print["_new-system"]&&"yes"!=e.print["_new-page"]?this.calculOffsetX(t):this.calculOffsetX(t)),y.offsetX=this.offsetX,y.offsetY=this.offsetY,void this.creerMesure(y)}parseInt(e.offsetX)&&(offsetX=e.offsetX),parseInt(e.offsetY)&&(offsetY=e.offsetY),parseInt(e.width)&&(h=e.width),e.clef&&(c=this.clef),e.chiffrage&&(m=this.chiffrage),this.measures.length>0?this.measures.forEach(function(e,t){mesure=new u.VF.Stave(e.offsetX,e.offsetY,e.width),e.firstOnNewSystem&&(p=s(u.armature,u),p||(p=u.armature),mesure.addKeySignature(p),c=e.clef,c||(c=u.clef),mesure.addClef(c),m=e.chiffrage,m||(m=u.chiffrage),mesure.addTimeSignature(m)),mesure.setContext(u.ctx).draw(),r(u,mesure,u.partition.systeme.portee1[t]),2==u.NB_PORTEES_SYSTEME&&i(e,p,c,m)}):(mesure=new this.VF.Stave(offsetX,offsetY,h),c&&mesure.addClef(c),m&&mesure.addTimeSignature(m),this.armature=s(this.armature,this),this.armature&&mesure.addKeySignature(this.armature),mesure.setContext(this.ctx).draw()),u=null,h=null,l=null,c=null,m=null,p=null,d=null,g=null},calculOffsetX:function(e){for(var t=0,s=0;s<e;s++)t=this.partition.systeme.portee1[s]._width,this.measures[s].firstOnNewSystem&&(this.offsetX=this.leftMargin),this.offsetX+=parseInt(t);t=null},creerMelodieMesure:function(e,t,s,i){var r=[];this.voix.ACTIVE=s?s:this.voix.ACTIVE;for(var a=0;a<i.length;a++)Array.isArray(i[a])&&r.push(this.creerNote({measureType:this.CLE_SOL,notes:i[a],figureAndStem:i[a]}));var n=t.split("/"),o=parseInt(n[0]),f=parseInt(n[1]);this.voices.push(new this.VF.Voice({num_beats:o,beat_value:f}).addTickables(r)),this.VF.Formatter.FormatAndDraw(this.ctx,e,r)},creerNote:function(e){var t=this.CLE_SOL,s=["g/4"],i="q",r=[],a=!1,n=0,o=this;if(e&&(e.measureType&&(t=e.measureType),e.figureAndStem))switch(i=e.figureAndStem[0][1],stem=""!=e.figureAndStem[0][3]?e.figureAndStem[0][3]:0,stem){case"down":stem=-1;break;case"up":stem=1;break;default:stem=0}e.notes&&(s=[],e.notes.forEach(function(e){if(e[0][0].indexOf(".")>-1){var e=e[0][0],t=e.split(".");e[0]=t[0],r.push(n++),a=!0}else n++;s.push(o.genererNote(e))}));var f=new this.VF.StaveNote({clef:t,keys:s,duration:i,stem_direction:stem});return r.length>0&&a&&r.forEach(function(e){f.addDot(parseInt(e))}),f},genererNote:function(e){return e[0]+"/"+e[2]},calculPercent:function(e,t,s){return e?t*(100/s):t/100*s},dynamicSizingMeasure:function(){var e=this,t=this.partition.systeme.portee1.length,s=0,i=[],r=0;this.offsetX=this.leftMargin=this.options.default.sidePadding;for(var a=0;a<t;a++){var n=this.partition.systeme.portee1[a];this.measures.push({}),this.measures[a].num=a+1,e.systemOk&&(!n.print||"yes"!=n.print["_new-system"]&&"yes"!=n.print["_new-page"]||(this.measures[a].firstOnNewSystem=!0,0!=a&&(this.offsetY+=this.partition.systeme.portee2?250:120,this.measures[a-1].lastOnOldSystem=!0)),this.measures[a].offsetY=this.offsetY),this.loadAttributs(n,this.measures[a]),n.print&&n.print["system-layout"]&&n.print["system-layout"]["system-margins"]&&n.print["system-layout"]["system-margins"]["left-margin"]&&(this.leftMargin=parseInt(n.print["system-layout"]["system-margins"]["left-margin"]),this.measures[a].hasLeftMargin=!0,this.measures[a].offsetX=this.leftMargin),this.measures[a].hasLeftMargin||this.measures[a].firstOnNewSystem||a>0&&"1"!=n._number&&this.calculOffsetX(a),this.measures[a].hasLeftMargin||(this.measures[a].offsetX=this.offsetX),n=null}if(e.systemOk)this.measures.forEach(function(t,i){if(e.responsive)t.firstOnNewSystem&&(r=0,s++,t.clef=e.clef,t.chiffrage=e.chiffrage,t.armature=e.armature,t.mode=e.mode),r++;else{var a=e.partition.systeme.portee1[i];t.firstOnNewSystem&&(s++,t.clef=e.clef,t.chiffrage=e.chiffrage,t.armature=e.armature,t.mode=e.mode),t.width=parseInt(a._width)}});else for(var o=0,f=0,a=0;a<t;a++)(0==a||o==this.NB_MAX_MEASURES&&this.responsive)&&(this.measures[a].firstOnNewSystem=!0,this.loadAttributs(!1,this.measures[a]),0!=a&&(this.measures[a-1].lastOnOldSystem=!0,this.offsetY+=this.partition.systeme.portee2?250:120),o=0),this.measures[a].offsetY=this.offsetY,this.measures[a].width=window.innerWidth/this.NB_MAX_MEASURES,this.measures[a].firstOnNewSystem?this.measures[a].offsetX=e.options.default.sidePadding:this.measures[a].offsetX=f+e.options.default.sidePadding,f+=this.measures[a].width,o++;this.responsive&&e.calculLargeur(),this.creerMesure(!0),this.systemOk=!0,e=null,t=null,i=null,r=null},loadAttributs:function(e,t){e.attributes&&(e.attributes.time&&(this.chiffrage=e.attributes.time.beats+"/"+e.attributes.time["beat-type"],t.chiffrage=this.chiffrage),e.attributes.clef&&(this.clef="G"==e.attributes.clef.sign?this.CLE_SOL:this.CLE_FA,t.clef=this.clef),e.attributes.key&&(e.attributes.key.fifths&&(this.armature=e.attributes.key.fifths,t.armature=this.armature),e.attributes.key.mode&&(this.mode=e.attributes.key.mode)))},calculLargeur:function(){var e=this,t=window.innerWidth-2*this.options.default.sidePadding,s=parseInt(this.partition.infos.page.width),i=0,r=0,a=null,n=0,o=[],f=[],u=[],h=0,l=0,c=0,m=0;return this.measures.forEach(function(a,f){if(a.firstOnNewSystem){a.hasLeftMargin&&(l=a.offsetX,m=e.calculPercent(!0,l,s),h=e.calculPercent(!1,m,t));for(var u=0,p=a.num-1;p<e.measures.length&&(o.push(parseFloat(e.partition.systeme.portee1[p]._width)),n+=o[u],u++,!e.measures[p].lastOnOldSystem);p++);c=0!=h?h/o.length:0,i=s-n-l,m=e.calculPercent(!0,i,s),r=e.calculPercent(!1,m,t),c+=r/o.length,u=0,concatWidth=0;for(var p=a.num-1;p<e.measures.length&&(m=e.calculPercent(!0,o[u],e.partition.infos.page.width),e.measures[p].width=e.calculPercent(!1,m,t)+c,0==u?e.measures[p].offsetX=e.options.default.sidePadding:e.measures[p].offsetX=concatWidth+e.options.default.sidePadding,concatWidth+=e.measures[p].width,u++,!e.measures[p].lastOnOldSystem);p++);n=0,l=0,h=0,o=[],n=0}}),t=null,s=null,i=null,r=null,a=null,n=null,o=null,f=null,u=null,h=null,l=null,c=null,m=null,cpt=null,o}};