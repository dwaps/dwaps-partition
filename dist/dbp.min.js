function dwapsBuilderPart(){return function(e,t){return new DWAPS_BUILDER_PART(e,t)}}var options={use:{angular:!0},canvas:{width:window.innerWidth,height:window.innerHeight},font:{family:"Arial",size:10,weight:300},bgColor:"#eed",default:{measureWidth:500,sidePadding:10,offsetY:40,time:"4/4",responsive:!0},help:{clefs:function(e){console.log("\nValables Clefs :"),console.log(e.clefProperties.values)},notes:function(e){console.log("\nValables Notes :"),console.log(e.keyProperties.note_values)},accidentals:function(e){console.log("\nValables Accidentals :"),console.log(e.accidentalCodes.accidentals)},keys:function(e){console.log("\nValables Keys :"),console.log(e.keySignature.keySpecs)},duration:function(e){console.log("\nValables Duration :"),console.log(e.durationToTicks.durations)},articulations:function(e){console.log("\nValables Articulations :"),console.log(e.articulationCodes.articulations)},ornaments:function(e){console.log("\nValables Ornaments :"),console.log(e.ornamentCodes.ornaments)}}};options.use.angular&&angular.module("DWAPS_BUILDER_PART",[]).factory("dwapsBuilderPart",dwapsBuilderPart);var DWAPS_BUILDER_PART=function(e,t){var s=new X2JS,i=s.xml_str2json(t);this.initPart(i["score-partwise"]),this.start(e,options)};DWAPS_BUILDER_PART.prototype={initObject:function(e){return this.VF=Vex.Flow,this.options=e,this.responsive=this.options.default.responsive,this.NB_MAX_MEASURES=2,this.systemOk=!0,this.widthViewer=this.responsive?window.innerWidth:this.partition.infos.page.width,this.heightViewer=this.responsive?window.innerHeight:this.partition.infos.page.height,this.offsetX=this.options.default.sidePadding,this.offsetY=this.options.default.offsetY,this.mode="major",this.en={DOb:"Cb",SOLb:"Bb",REb:"Db",LAb:"Ab",MIb:"Eb",SIb:"Bb",FA:"F",DO:"C",SOL:"G",RE:"D",LA:"A",MI:"E#",SI:"B#",FAd:"F#",DOd:"D#"},this.measures=[],this.SIZES_SYSTEM_AUTO=!0,this.largTotaleMes=0,this.indexFirstMeasureSystem=0,this.mesWidth=[],this.leftMargin=this.options.default.sidePadding,this.CLE_SOL="treble",this.CLE_FA="bass",this.clef=this.CLE_SOL,this.chiffrage=this.options.default.time,this.armature=null,this.note={DO:"c",RE:"d",MI:"e",FA:"f",SOL:"g",LA:"a",SI:"b",DO_POINTEE:"c.",RE_POINTEE:"d.",MI_POINTEE:"e.",FA_POINTEE:"f.",SOL_POINTEE:"g.",LA_POINTEE:"a.",SI_POINTEE:"b."},this.figure={RONDE:"w",BLANCHE:"h",NOIRE:"q",CROCHE:"8",DOUBLE_CROCHE:"16",TRIPLE_CROCHE:"32",QUADRUPLE_CROCHE:"64"},this.voix={BASSE:"basse",TENOR:"tenor",ALTO:"alto",SOPRANO:"soprano",NULL:"aucune voix précisée",ACTIVE:""},this.voices=[],this.noteTest=["c/4"],this},initCanvas:function(e){this.tag=e;var t=this.renderer=new this.VF.Renderer(e,this.VF.Renderer.Backends.SVG);t.resize(this.widthViewer,this.heightViewer);var s=this.ctx=t.getContext();s.setFont(options.font.family,options.font.size,options.font.weight).setBackgroundFillStyle(options.bgColor)},start:function(e,t){t.default.responsive?this.reload(e,t):(this.initObject(t),this.initCanvas(e),this.buildPart())},setOptions:function(e){this.options=e},getOptions:function(){return this.options},initPart:function(e){function t(t){var s=[];return e.part[t-1].measure.forEach(function(e){s.push(e)}),s}var s={infos:{page:{width:e.defaults["page-layout"]["page-width"],height:e.defaults["page-layout"]["page-height"]},titre:e.work["work-title"],ref:e.identification.creator.__text,systeme:[]},systeme:{portee1:t(1),portee2:!!e.part[1]&&t(2)}};e["part-list"]["score-part"].forEach(function(e){s.infos.systeme.push(e["part-name"])}),this.partition=s},reload:function(e,t){if(this.responsive||this.options&&this.options.default.responsive||t&&t.default.responsive){console.log("reloading...");var s=window.innerWidth;e&&t?(this.initObject(t),this.initCanvas(e)):(this.initObject(this.options),this.tag.innerHTML="",this.initCanvas(this.tag)),s<=1024?(s<=450?this.NB_MAX_MEASURES=1:s<=700?this.NB_MAX_MEASURES=2:s<=768?this.NB_MAX_MEASURES=3:this.NB_MAX_MEASURES=4,this.systemOk=!1):this.systemOk=!0,this.buildPart()}else e&&t&&this.start(e,t)},buildPart:function(){this.dynamicSizingMeasure()},creerMesure:function(e,t){function s(e,t,s){var n=[],a={soprano:[],alto:[],tenor:[],basse:[],sansVoix:[]};s.note.forEach(function(e,t){if("4"==s._number&&(n.push({voix:e.voice?e.voice:"",pos:e.pitch.octave?parseInt(e.pitch.octave):"",figure:e.type?e.type:"",ton:e.pitch.step?e.pitch.step:"",hampe:e.stem?e.stem:"",paroles:[],offsetX:e["_default-x"]}),e.lyric))for(j=0;j<e.lyric.length;j++)""!=e.lyric[j].text&&n[t].paroles.push(e.lyric[j].text)});var r=[];n.forEach(function(e,t){if(i(e),t-1>=0&&s.note[t-1]["_default-x"]==e.offsetX)switch(e.voix){case"2":a.alto[r.length-1]=e;break;case"1":a.tenor[r.length-1]=e;break;default:a.sansVoix[r.length-1]=e}else{switch(e.voix){case"2":a.alto.push(e);break;case"1":a.tenor.push(e);break;default:a.sansVoix.push(e)}for(var n in a)r.length<a[n].length&&(r=a[n]);for(var n in a)a[n].length<r.length&&a[n].push(null)}});for(var o in a)if(a.tenor.length>0){var u=[];switch(a.tenor.forEach(function(e,t){if(e)if(a.sansVoix[t]){var s=[],i=[];if(a.sansVoix[t].pos>e.pos)s.push(e.ton,e.figure,e.pos),i.push(a.sansVoix[t].ton,a.sansVoix[t].figure,a.sansVoix[t].pos);else if(a.sansVoix[t].pos==e.pos)for(var n=["c","d","e","f","g","a","b"],r=-1,o=-1,h=0;h<7;h++)e.ton==n[h]&&(r=h),a.sansVoix[t].ton==n[h]&&(o=h),r>-1&&o>-1&&(r>o?(s.push(e.ton,e.figure,e.pos),i.push(a.sansVoix[t].ton,a.sansVoix[t].figure,a.sansVoix[t].pos)):(s.push(e.ton,e.figure,e.pos),i.push(a.sansVoix[t].ton,a.sansVoix[t].figure,a.sansVoix[t].pos)));else s.push(a.sansVoix[t].ton,a.sansVoix[t].figure,a.sansVoix[t].pos),i.push(e.ton,e.figure,e.pos);u.push([s,i])}else u.push([[e.ton,e.figure,e.pos]])}),o){case"tenor":e.creerMelodieMesure(t,e.chiffrage,e.voix.TENOR,u);break;case"sansVoix":}}}function i(e){if(e){switch(e.figure){case"half":e.figure=a.figure.BLANCHE;break;case"quarter":e.figure=a.figure.NOIRE}switch(e.ton){case"C":e.ton=a.note.DO;break;case"D":e.ton=a.note.RE;break;case"E":e.ton=a.note.MI;break;case"F":e.ton=a.note.FA;break;case"G":e.ton=a.note.SOL;break;case"A":e.ton=a.note.LA;break;case"B":e.ton=a.note.SI}}}function n(e,t){var s=!!e.match("-");switch(e=e.replace("-","")){case"1":e=s?t.en.FA:t.en.SOL;break;case"2":e=s?t.en.SIb:t.en.RE;break;case"3":e=s?t.en.MIb:t.en.LA;break;case"4":e=s?t.en.LAb:t.en.MI;break;case"5":e=s?t.en.REb:t.en.SI;break;case"6":e=s?t.en.SOLb:t.en.FAd;break;case"7":e=s?t.en.DOb:t.en.DOd;break;default:e="major"==t.mode?t.en.DO:t.en.LAm}return e}var a=this,r=this.options.default.measureWidth,o=[],u=null,h=null,f=null,l=null,c=[];if(!this.responsive&&e&&t>=0){var p={width:parseInt(e._width)};return e.attributes&&(e.attributes.time&&(this.chiffrage=e.attributes.time.beats+"/"+e.attributes.time["beat-type"]),e.attributes.clef&&(this.clef="G"==e.attributes.clef.sign?this.CLE_SOL:this.CLE_FA),e.attributes.key&&(e.attributes.key.fifths&&(this.armature=e.attributes.key.fifths),e.attributes.key.mode&&(this.mode=e.attributes.key.mode))),e.print&&("yes"!=e.print["_new-system"]&&"yes"!=e.print["_new-page"]||(this.indexFirstMeasureSystem=parseInt(e._number)-1,this.leftMargin=this.options.default.sidePadding,"yes"==e.print["_new-system"]&&(this.offsetY+=120),p.clef=this.clef,p.chiffrage=this.chiffrage,p.armature=this.armature,0==t&&e.print["system-layout"]&&e.print["system-layout"]["system-margins"]&&e.print["system-layout"]["system-margins"]["left-margin"]&&(this.leftMargin=parseInt(e.print["system-layout"]["system-margins"]["left-margin"]),this.leftMargin=this.leftMargin-15))),this.offsetX=this.leftMargin,t>0&&"1"!=e._number&&(!e.print||e.print&&"yes"!=e.print["_new-system"]&&"yes"!=e.print["_new-page"]?this.calculOffsetX(t):this.calculOffsetX(t)),p.offsetX=this.offsetX,p.offsetY=this.offsetY,void this.creerMesure(p)}parseInt(e.offsetX)&&(offsetX=e.offsetX),parseInt(e.offsetY)&&(offsetY=e.offsetY),parseInt(e.width)&&(r=e.width),e.clef&&(u=this.clef),e.chiffrage&&(h=this.chiffrage),this.measures.length>0?this.measures.forEach(function(e,t){if(mesure=new a.VF.Stave(e.offsetX,e.offsetY,e.width),e.firstOnNewSystem){var i=n(a.armature,a);i?mesure.addKeySignature(i):mesure.addKeySignature(a.armature),e.clef?mesure.addClef(e.clef):mesure.addClef(a.clef),e.chiffrage?mesure.addTimeSignature(e.chiffrage):mesure.addTimeSignature(a.chiffrage)}mesure.setContext(a.ctx).draw(),s(a,mesure,a.partition.systeme.portee1[t])}):(mesure=new this.VF.Stave(offsetX,offsetY,r),u&&mesure.addClef(u),h&&mesure.addTimeSignature(h),this.armature=n(this.armature,this),this.armature&&mesure.addKeySignature(this.armature),mesure.setContext(this.ctx).draw()),a=null,r=null,o=null,u=null,h=null,f=null,l=null,c=null},calculOffsetX:function(e){for(var t=0,s=0;s<e;s++)t=this.partition.systeme.portee1[s]._width,this.measures[s].firstOnNewSystem&&(this.offsetX=this.leftMargin),this.offsetX+=parseInt(t);t=null},creerMelodieMesure:function(e,t,s,i){var n=[];this.voix.ACTIVE=s?s:this.voix.ACTIVE;for(var a=0;a<i.length;a++)if(Array.isArray(i[a]))switch(this.voix.ACTIVE){case this.voix.BASSE:n.push(this.creerNote({measureType:this.CLE_SOL,notes:i[a],figure:i[a][0][1]}));break;case this.voix.TENOR:n.push(this.creerNote({measureType:this.CLE_SOL,notes:i[a],figure:i[a][0][1]}));break;case this.voix.ALTO:break;case this.voix.SOPRANO:break;case this.voix.NULL:n.push(this.creerNote({measureType:this.CLE_SOL,notes:i[a],figure:i[a][0][1]}))}var r=t.split("/"),o=parseInt(r[0]),u=parseInt(r[1]);this.voices.push(new this.VF.Voice({num_beats:o,beat_value:u}).addTickables(n)),this.VF.Formatter.FormatAndDraw(this.ctx,e,n)},creerNote:function(e){var t=this.CLE_SOL,s=["g/4"],i="q",n=[],a=!1,r=0,o=this;e&&(e.measureType&&(t=e.measureType),e.figure&&(i=e.figure)),e.notes&&(s=[],e.notes.forEach(function(e){switch(e[0]){case o.note.DO_POINTEE:e=o.splitPoint(e),n.push(r++),a=!0;break;case o.note.RE_POINTEE:e=o.splitPoint(e),n.push(r++),a=!0;break;case o.note.MI_POINTEE:e=o.splitPoint(e),n.push(r++),a=!0;break;case o.note.FA_POINTEE:e=o.splitPoint(e),n.push(r++),a=!0;break;case o.note.SOL_POINTEE:e=o.splitPoint(e),n.push(r++),a=!0;break;case o.note.LA_POINTEE:e=o.splitPoint(e),n.push(r++),a=!0;break;case o.note.SI_POINTEE:e=o.splitPoint(e),n.push(r++),a=!0;break;default:r++}s.push(o.genererNote(e))}));var u=new this.VF.StaveNote({clef:t,keys:s,duration:i});return n.length>0&&a&&n.forEach(function(e){u.addDot(parseInt(e))}),u},genererNote:function(e){return e[0]+"/"+e[2]},splitPoint:function(e,t){var s=e[0].split(".");return e[0]=s[0],e},calculPercent:function(e,t,s){return e?t*(100/s):t/100*s},dynamicSizingMeasure:function(){var e=this,t=this.partition.systeme.portee1.length,s=0,i=[],n=0;this.offsetX=this.leftMargin=this.options.default.sidePadding;for(var a=0;a<t;a++){var r=this.partition.systeme.portee1[a];this.measures.push({}),this.measures[a].num=a+1,e.systemOk&&(!r.print||"yes"!=r.print["_new-system"]&&"yes"!=r.print["_new-page"]||(this.measures[a].firstOnNewSystem=!0,0!=a&&(this.offsetY+=120,this.measures[a-1].lastOnOldSystem=!0)),this.measures[a].offsetY=this.offsetY),this.loadAttributs(r,this.measures[a]),r.print&&r.print["system-layout"]&&r.print["system-layout"]["system-margins"]&&r.print["system-layout"]["system-margins"]["left-margin"]&&(this.leftMargin=parseInt(r.print["system-layout"]["system-margins"]["left-margin"]),this.measures[a].hasLeftMargin=!0,this.measures[a].offsetX=this.leftMargin),this.measures[a].hasLeftMargin||this.measures[a].firstOnNewSystem||a>0&&"1"!=r._number&&this.calculOffsetX(a),this.measures[a].hasLeftMargin||(this.measures[a].offsetX=this.offsetX),r=null}if(e.systemOk)this.measures.forEach(function(t,i){if(e.responsive)t.firstOnNewSystem&&(n=0,s++,console.log("Système n°"+s+" (partition responsive)"),t.clef=e.clef,t.chiffrage=e.chiffrage,t.armature=e.armature,t.mode=e.mode),n++;else{var a=e.partition.systeme.portee1[i];t.firstOnNewSystem&&(s++,console.log("Système n°"+s+" (partition statique)"),t.clef=e.clef,t.chiffrage=e.chiffrage,t.armature=e.armature,t.mode=e.mode),t.width=parseInt(a._width)}});else for(var o=0,u=0,a=0;a<t;a++)(0==a||o==this.NB_MAX_MEASURES&&this.responsive)&&(this.measures[a].firstOnNewSystem=!0,this.loadAttributs(!1,this.measures[a]),0!=a&&(this.measures[a-1].lastOnOldSystem=!0,this.offsetY+=120),o=0),this.measures[a].offsetY=this.offsetY,this.measures[a].width=window.innerWidth/this.NB_MAX_MEASURES,this.measures[a].firstOnNewSystem?this.measures[a].offsetX=e.options.default.sidePadding:this.measures[a].offsetX=u+e.options.default.sidePadding,u+=this.measures[a].width,o++;this.responsive&&e.calculLargeur(),this.creerMesure(!0),this.systemOk=!0,e=null,t=null,i=null,n=null},loadAttributs:function(e,t){e.attributes&&(e.attributes.time&&(this.chiffrage=e.attributes.time.beats+"/"+e.attributes.time["beat-type"],t.chiffrage=this.chiffrage),e.attributes.clef&&(this.clef="G"==e.attributes.clef.sign?this.CLE_SOL:this.CLE_FA,t.clef=this.clef),e.attributes.key&&(e.attributes.key.fifths&&(this.armature=e.attributes.key.fifths,t.armature=this.armature),e.attributes.key.mode&&(this.mode=e.attributes.key.mode)))},calculLargeur:function(){var e=this,t=window.innerWidth-2*this.options.default.sidePadding,s=parseInt(this.partition.infos.page.width),i=0,n=0,a=null,r=0,o=[],u=[],h=[],f=0,l=0,c=0,p=0;return this.measures.forEach(function(a,u){if(a.firstOnNewSystem){a.hasLeftMargin&&(l=a.offsetX,p=e.calculPercent(!0,l,s),f=e.calculPercent(!1,p,t));for(var h=0,m=a.num-1;m<e.measures.length&&(o.push(parseFloat(e.partition.systeme.portee1[m]._width)),r+=o[h],h++,!e.measures[m].lastOnOldSystem);m++);c=0!=f?f/o.length:0,i=s-r-l,p=e.calculPercent(!0,i,s),n=e.calculPercent(!1,p,t),c+=n/o.length,h=0,concatWidth=0;for(var m=a.num-1;m<e.measures.length&&(p=e.calculPercent(!0,o[h],e.partition.infos.page.width),e.measures[m].width=e.calculPercent(!1,p,t)+c,0==h?e.measures[m].offsetX=e.options.default.sidePadding:e.measures[m].offsetX=concatWidth+e.options.default.sidePadding,concatWidth+=e.measures[m].width,h++,!e.measures[m].lastOnOldSystem);m++);r=0,l=0,f=0,o=[],r=0}}),t=null,s=null,i=null,n=null,a=null,r=null,o=null,u=null,h=null,f=null,l=null,c=null,p=null,cpt=null,o}};